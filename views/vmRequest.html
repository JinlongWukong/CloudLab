<!DOCTYPE html>
<html>
<head>
    <title>VM Operation</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/axios/0.18.0/axios.min.js"></script>
    <script src="/scripts/bootstrap.min.js"></script>
    <script src="/scripts/auth.js"></script>
    <script src="/scripts/vue.min.js"></script>
</head>

<body>
    <div id="vmApp">
        <div class="btn-group pull-right" role="group" aria-label="...">
            <button type="button" class="btn btn-info" ref="getAllVmInfo" v-on:click="getAllVm">
                <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
              </button>
            <!--a href="#" v-on:click="getAllVm"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></a-->
            <button type="button" class="btn btn-primary">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
            </button>
            <!--a href="#"><span class="glyphicon glyphicon-plus"></span></a-->
            <button type="button" class="btn btn-danger">
                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
            </button>
            <!--a href="#"><span class="glyphicon glyphicon-trash"></span></a-->
        </div>
        <table class="table table-hover table-striped">
            <thead>
              <tr>
                <th>
					<label class="form-checkbox">
                    <input type="checkbox" v-model="selectAll" @click="select">
                    <i class="form-icon"></i>
                    </label>
				</th>
                <th>Name</th>
                <th>Hostname</th>
                <th>Cpu</th>
                <th>Mem</th>
                <th>Disk</th>
                <th>Address</th>
                <th>Status</th>
                <th>Vnc</th>
                <th>NoVnc</th>
                <th>Type</th>
                <th>Node</th>
                <th>LifeTime</th>
                <th>PortMapping</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="vm in vmList" :key="vm.name">
                  <td>
					<label class="form-checkbox">
    				  <input type="checkbox" :value="vm.name" v-model="selected">
					  <vm class="form-icon"></vm>
  					</label>
				  </td>
                  <td v-html="vm.name"></td>
                  <td>{{vm.hostname}}</td>
                  <td>{{vm.cpu}}</td>
                  <td>{{vm.mem}}</td>
                  <td>{{vm.disk}}</td>
                  <td>{{vm.address}}</td>
                  <td>{{vm.status}}</td>
                  <td>{{vm.vnc}}</td>
                  <td v-html="vm.novnc"></td>
                  <td>{{vm.type}}</td>
                  <td>{{vm.node}}</td>
                  <td>{{vm.lifeTime}}</td>
                  <td v-html="vm.portMap"></td>
                  <td>
                    <div class="btn-group">
                        <button type="button" class="btn btn-success" @click="vmAction(vm.name, 'start')">start</button>
                        <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                          <li><a href="#">shutdown</a></li>
                          <li><a href="#">reboot</a></li>
                          <li><a href="#">extend</a></li>
                          <li><a href="#">expose-port</a></li>
                        </ul>
                      </div>
                  </td>
              </tr>
            </tbody>
        </table>        
    </div>
    <script>
        var vmApp = new Vue({
            el: "#vmApp",
            data: {
                msg: "xxx",
                vmList: [],
                selected: [],
		        selectAll: false
            },
            methods: {
                getAllVm() {
                    var loginInfo = getLoginInfo()
                    var token = loginInfo.token 
                    var baseurl = location.origin;
                    var that = this
                    axios.get(baseurl + "/vm", {
                        headers: {
                            "Authorization": "Bearer "+ token
                        },
                    })
                    .then(function (response) {
                        console.log(response.data)
                        that.convertVmList(response.data)
                    })
                    .catch(function (error) {
                        console.log(error);
                        alert(error.status); // show response
                    });
                },
                convertVmList(vmList) {
                    var that = this
                    console.log("start convert vm list")
                    vmList.forEach(vm => {
                      //vm web terminal
                      var url = location.origin + "/vm/" + vm.name + "/web-terminal"
                      vm.name = "<a href="+ url +">" + vm.name + "</a>"
                      //novnc
                      if (vm.novnc) {
                        vm.novnc = "<a href=" + vm.novnc + ">link</a>"
                      }
                      //portmapping
                      var result = ""
                      for(var key in vm.portMap) {
                        var value = vm.portMap[key];
                        result = result + key + "->" + value + "<br>"
                      }
                      vm.portMap = result
                      //vnc
                      vm.vnc = vm.vnc["port"]
                      //lifetime
                      vm.lifeTime = vm.lifeTime/3600000000000 + "h"
                    })
                    console.log(vmList)
                    that.vmList = vmList
                },
                vmAction(name, action) {
                    var that = this
                    var loginInfo = getLoginInfo();
                    var token = loginInfo.token;
                    var baseurl = location.origin;
                    console.log(baseurl)
                    console.log(name)
                    console.log(action)
                    axios.post(baseurl + "/vm/" + name + "/" + action)
                        .then(function (response) {
                            console.log(response);
                            that.$refs.getAllVmInfo.click()
                        })
                        .catch(function (error) {
                            console.log(error);
                            alert(error.status); // show response
                        });
                },
                select() {
			        this.selected = [];
			        if (!this.selectAll) {
			    	    for (let i in this.items) {
				    	    this.selected.push(this.items[i].name);
				        }
			        }
		        }
            }
        })
    </script>
</body>
</html>